<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Motaz Mohammad">
<title>Distributed Transaction</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Asciidoctor Tabs | Copyright (c) 2018-present Dan Allen | MIT License */
.tabs {
    margin-bottom: 1.25em;
}

.tablist > ul {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
    margin: 0;
    padding: 0;
}

.tablist > ul li {
    align-items: center;
    background-color: #fff;
    cursor: pointer;
    display: flex;
    font-weight: bold;
    line-height: 1.5;
    padding: 0.25em 1em;
    position: relative;
}

.tablist > ul li:focus-visible {
    outline: none;
}

.tablist.ulist,
.tablist.ulist > ul li {
    margin: 0;
}

.tablist.ulist > ul li + li {
    margin-left: 0.25em;
}

.tabs .tablist li::after {
    content: "";
    display: block;
    height: 1px;
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
}

.tabs.is-loading .tablist li:not(:first-child),
.tabs:not(.is-loading) .tablist li:not(.is-selected) {
    background-color: #f5f5f5;
}

.tabs.is-loading .tablist li:first-child::after,
.tabs:not(.is-loading) .tablist li.is-selected::after {
    background-color: #fff;
}

/*
.tabs:not(.is-loading) .tablist li,
.tabs:not(.is-loading) .tablist li::after {
  transition: background-color 200ms ease-in-out;
}
*/

.tablist > ul p {
    line-height: inherit;
    margin: 0;
}

.tabpanel {
    background-color: #fff;
    padding: 1.25em;
}

.tablist > ul li,
.tabpanel {
    border: 1px solid #dcdcdc;
}

.tablist > ul li {
    border-bottom: 0;
}

.tabs.is-loading .tabpanel + .tabpanel,
.tabs:not(.is-loading) .tabpanel.is-hidden {
    display: none;
}

.tabpanel > :first-child {
    margin-top: 0;
}

/* #content is a signature of the Asciidoctor standalone HTML output */
#content .tabpanel > :last-child,
#content .tabpanel > :last-child > :last-child,
#content .tabpanel > :last-child > :last-child > li:last-child > :last-child {
    margin-bottom: 0;
}

.tablecontainer {
    overflow-x: auto;
}

#content .tablecontainer {
    margin-bottom: 1.25em;
}

#content .tablecontainer > table.tableblock {
    margin-bottom: 0;
}
</style>
</head>
<body class="article">
<div id="header">
<h1>Distributed Transaction</h1>
<div class="details">
<span id="author" class="author">Motaz Mohammad</span><br>
<span id="email" class="email"><a href="mailto:motazco135@gmail.com">motazco135@gmail.com</a></span><br>
<span id="revnumber">version 3.0,</span>
<span id="revdate">July 11, 2024</span>
<br><span id="revremark">AsciiDoc article template</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_what_is_distributed_transaction">What is Distributed Transaction?</a>
<ul class="sectlevel2">
<li><a href="#_what_is_the_problem">What is the problem ?</a></li>
</ul>
</li>
<li><a href="#_possible_solutions">Possible Solutions</a></li>
<li><a href="#_saga_design_pattern">SAGA Design Pattern</a>
<ul class="sectlevel2">
<li><a href="#_two_ways_of_implementing_saga_pattern">Two ways of implementing Saga Pattern</a></li>
<li><a href="#_why_orchestration_saga_pattern">Why Orchestration Saga Pattern</a></li>
</ul>
</li>
<li><a href="#_implementing_saga_orchestration">Implementing Saga Orchestration</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>One of the common issues is how to manage the Distributed Transaction across multiple microservices, There is a lot of patterns to manage distributed transaction, In this article I will try to share one of the common patters and will try to share a sample code base.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_is_distributed_transaction">What is Distributed Transaction?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When microservice architecture decomposes a monolithic systems into self-encapsulated service, this breaks the transaction, Which mean that a local transaction in the monolithic system is now distributed into multiple service.</p>
</div>
<div class="paragraph">
<p>A distributed transaction is a very complex process with a lot of moving parts that can fail, which could seriously effects the user experience and overall system, <strong>So the best way to solve distributed transactions problem is to avoid them</strong></p>
</div>
<div class="paragraph">
<p>Here is a Bank Payment Transfer transaction example with a monolithic system which using local transaction:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/dt/monolithic-trans.png" alt="monolithic - Bank Payment transaction">
</div>
</div>
<div class="paragraph">
<p>In Bank Payment transaction example above, if the customer sends a <strong>"Transfer"</strong> action to the Payment Systems, Payment System Validate the Payment and get transfer fee, debit the customer account with amount ,
credit the receiver account with the amount and Post transaction details and now transfer request will be confirmed.</p>
</div>
<div class="paragraph">
<p>So in monolithic systems if any step of the transaction flow failed, The transaction can <strong>roll back</strong>. This is knows as <strong>ACID</strong> (Atomicity, Consistency, Isolation, Durability), which is guaranteed by the database system.</p>
</div>
<div class="paragraph">
<p>When we decompose this system into multiple microservice, We created  <code>PaymentMiacroservice</code> ,<code>FeeMiacroservice</code> , <code>AccountMicroservice</code> and <code>JournalMicroservice</code> which have separated databases, now hte customer transfer action will be as following :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/dt/transfer-microservice.png" alt="microservice - Bank Payment transaction">
</div>
</div>
<div class="paragraph">
<p>When customer sends a <strong>"Do Transfer"</strong> action, <code>PaymentMiacroservice</code>
<code>FeeMiacroservice</code> , <code>AccountMicroservice</code> and <code>JournalMicroservice</code> will be called to apply the change into their own database.
Because the transaction is now across multiple databases, it is now considered a <code>Distribted truansaction</code>.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_problem">What is the problem ?</h3>
<div class="paragraph">
<p>In monolithic application, We have a database to ensure <strong>ACIDity</strong>.
but with distributed systems now we need to clarify <strong>How do we keep the transaction atomic?</strong>
The business transaction can span across multiple service which are composed of multiple local transaction within individual services.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_possible_solutions">Possible Solutions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the Solutions to implement Distributed transactions is :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SAGA Design Pattern</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_saga_design_pattern">SAGA Design Pattern</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Saga is a sequence of local transactions.Each local transaction updates the database and publishes an event to trigger the next local transaction in the saga, each local transaction has a corresponding compensating transaction in order to roll back.</p>
</div>
<div class="paragraph">
<p>If a local transaction fails, the saga executes a series of compensating transactions to roll back the changes made by the previous transactions.This ensures that the system remains consistent event when transactions fail.</p>
</div>
<div class="paragraph">
<p>In Saga pattern, a compensating transaction must be idempotent and retryable.</p>
</div>
<div class="paragraph">
<p>In our example above the transfer action consists of sequential steps as following :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/dt/SAGA-Flow.png" alt="microservice - Bank Payment transaction">
</div>
</div>
<div class="sect2">
<h3 id="_two_ways_of_implementing_saga_pattern">Two ways of implementing Saga Pattern</h3>
<div class="paragraph">
<p>The Saga Pattern can be implemented in two different ways :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Choreography</strong> - each local transaction publishes events that trigger local transaction in other service, there is no centralized coordinator , making communication between services more difficult.</p>
<div class="imageblock">
<div class="content">
<img src="resources/dt/Choreography%20Saga.png" alt="Choreography Saga">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Choreography based SAGA can further be implemented in two ways based on how events are being used:</p>
<div class="ulist">
<ul>
<li>
<p>Choreography using Outbox Store (Outbox Pattern)</p>
</li>
<li>
<p>Choreography using Event Sourcing(Event Sourcing Pattern)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Orchestration</strong> - All microservice are linked to the centralized coordinator that orchestrates the services in a predefined order to complete or roll back a business transaction.</p>
<div class="imageblock">
<div class="content">
<img src="resources/dt/Orchestration%20Saga.png" alt="Orchestration Saga">
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_why_orchestration_saga_pattern">Why Orchestration Saga Pattern</h3>
<div class="paragraph">
<p>The decentralized approach in the choreography pattern make it more challenging to manage and monitor the service interaction.The Complexity increase with a lack of centralized coordination and visibility which making the application harder to maintain.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_saga_orchestration">Implementing Saga Orchestration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, let’s look at a practical example of an application employing the Saga Pattern with using <a href="https://camel.apache.org/components/4.4.x/eips/saga-eip.html">Apache Camel</a> and <a href="https://kafka.apache.org/">Kafka</a> .</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Payment Service</strong> : The Payment service receives a request to create a new transfer request, including transfer details such as
Sender account number, Receiver account number, transfer amount and the transfer notes.</p>
</li>
<li>
<p><strong>Fee service</strong> : The Payment service communicates with the fee service to get the transfer fees based on  transfer amount, and then the transfer request can proceed.</p>
</li>
<li>
<p><strong>Account Service</strong> : Once transfer request is confirmed, the payment service will contact the account service to Debit the sender account and credit the receiver account, This step ensures the sender has sufficient funds before credit the receiver account.</p>
</li>
<li>
<p><strong>Journal Service</strong> : If the Account Service completed successfully , the Journal Service will be called to write the journal entries in the database and update the transfer status.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The logic will be distributed among :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Payment Microservice</p>
</li>
<li>
<p>Fee Microservice</p>
</li>
<li>
<p>Account Microservice</p>
</li>
<li>
<p>Journal Microservice</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We will also implement to <a href="https://www.baeldung.com/cs/outbox-pattern-microservices">Outbox</a> and <a href="https://softwaremill.com/microservices-101/">Inbox</a> pattern to make sure that the message is processed one time.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">We will create the following microservice:</div>
<ul>
<li>
<p>payment</p>
</li>
<li>
<p>fee</p>
</li>
<li>
<p>account</p>
</li>
<li>
<p>journal</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/dt/project-structure.png" alt="Project Structure">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s start implementation :</p>
</div>
<div class="ulist">
<div class="title">payment Microservice:</div>
<ul>
<li>
<p>Controller in the Payment Microservice to receive transfer request , performs basic validation, and saves the message to the outbox table.</p>
</li>
<li>
<p><strong>TransferController.java</strong></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@RestController</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#007">@RequestMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/v1/transfer</span><span style="color:#710">&quot;</span></span>)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">TransferController</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> TransferService transferService;

    <span style="color:#007">@PostMapping</span>
    <span style="color:#088;font-weight:bold">public</span> ResponseEntity&lt;?&gt; createTransferRequest(<span style="color:#007">@RequestBody</span> CreateTransferRequest createTransferRequest) <span style="color:#088;font-weight:bold">throws</span> JsonProcessingException {
        <span style="color:#777">// Basic validation</span>
        <span style="color:#080;font-weight:bold">if</span>(createTransferRequest.getTransferAmount()==<span style="color:#00D">0</span>
        || createTransferRequest.getReceiverAccountNumber() == <span style="color:#069">null</span>
        || createTransferRequest.getSenderAccountNumber() == <span style="color:#069">null</span>)
        {
            <span style="color:#080;font-weight:bold">return</span> ResponseEntity.badRequest().body(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Invalid request</span><span style="color:#710">&quot;</span></span>);
        }<span style="color:#080;font-weight:bold">else</span>{

            CreateTransferResponse transferResponse = transferService.createTransferRequest(createTransferRequest);
            <span style="color:#080;font-weight:bold">return</span> ResponseEntity.status(HttpStatus.CREATED)
                    .body(transferResponse);
        }
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p><strong>TransferService.java</strong></p>
<div class="paragraph">
<p>In the TransferService we will create a method to receive the Transfer request and create and save Payment request in the OutBox entity with status "PENDING" where we will use a schedule job to read transfers requests with status PENDING and publish it to KAFKA topic "payment-request".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"> <span style="color:#007">@Transactional</span>
    <span style="color:#088;font-weight:bold">public</span> CreateTransferResponse  createTransferRequest(CreateTransferRequest createTransferRequest) <span style="color:#088;font-weight:bold">throws</span> JsonProcessingException {

        <span style="color:#777">// Create a unique payment ID</span>
        <span style="color:#0a8;font-weight:bold">UUID</span> paymentId = <span style="color:#0a8;font-weight:bold">UUID</span>.randomUUID();
        TransferDto transferDto = TransferDto.builder()
                .paymentId(paymentId)
                .requestId(createTransferRequest.getRequestId())
                .transferAmount(createTransferRequest.getTransferAmount())
                .transferReason(createTransferRequest.getTransferReason())
                .senderAccountNumber(createTransferRequest.getSenderAccountNumber())
                .receiverAccountNumber(createTransferRequest.getReceiverAccountNumber())
                .state(TransferState.PENDING).build();

        <span style="color:#777">// Save outbox message</span>
        outboxService.saveMessage(paymentId,PAYMENT_REQUEST_TOPIC,mapper.writeValueAsString(transferDto));

        <span style="color:#777">// Return response</span>
        <span style="color:#080;font-weight:bold">return</span> CreateTransferResponse.builder()
                .paymentId(transferDto.getPaymentId())
                .state(transferDto.getState()).build();
    }

    <span style="color:#007">@Transactional</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> processTransferRequest(<span style="color:#0a8;font-weight:bold">String</span> paymentDetails ) <span style="color:#088;font-weight:bold">throws</span> JsonProcessingException {
        log.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">processTransferRequest payment details : {} </span><span style="color:#710">&quot;</span></span>,paymentDetails);
        <span style="color:#777">//convert json to object</span>
        TransferDto transferDto = mapper.readValue(paymentDetails,TransferDto.class);

        <span style="color:#777">//save Transfer in the DB</span>
        TransferEntity transferEntity =  <span style="color:#080;font-weight:bold">new</span> TransferEntity();
        transferEntity.setPaymentId(transferDto.getPaymentId());
        transferEntity.setRequestId(transferDto.getRequestId());
        transferEntity.setReceiverAccountNumber(transferDto.getReceiverAccountNumber());
        transferEntity.setSenderAccountNumber(transferDto.getSenderAccountNumber());
        transferEntity.setTransferAmount(transferDto.getTransferAmount());
        transferEntity.setTransferReason(transferDto.getTransferReason());
        transferEntity.setState(TransferState.PROCESSING);
        transferRepository.save(transferEntity);
    }</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now we will create OutBox Pattern to be able to send the transfer request details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OutboxMessageEntity.java</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Data</span>
<span style="color:#007">@Entity</span>
<span style="color:#007">@Table</span>(name=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">t_outbox_message</span><span style="color:#710">&quot;</span></span>)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OutboxMessageEntity</span> {
    <span style="color:#007">@Id</span>
    <span style="color:#007">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Long</span> id;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> aggregateType;<span style="color:#777">//denotes the kind of entity we’re dealing with</span>

    <span style="color:#007">@Column</span>(nullable = <span style="color:#069">false</span>,columnDefinition = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">VARCHAR(255)</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> payload;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">UUID</span> PaymentId;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> status;<span style="color:#777">//message status</span>

    <span style="color:#007">@Column</span>(updatable = <span style="color:#069">false</span>, name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">created_at</span><span style="color:#710">&quot;</span></span> , columnDefinition = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">TIMESTAMP</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> LocalDateTime createdAt;

    <span style="color:#007">@Column</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">processed_at</span><span style="color:#710">&quot;</span></span> , columnDefinition = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">TIMESTAMP</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> LocalDateTime processedAt;

    <span style="color:#007">@PrePersist</span>
    <span style="color:#339;font-weight:bold">void</span> setCreatedAt(){
        <span style="color:#950">this</span>.createdAt = LocalDateTime.now();
    }

    <span style="color:#007">@PreUpdate</span>
    <span style="color:#339;font-weight:bold">void</span> setProcessedAt(){
        <span style="color:#950">this</span>.processedAt = LocalDateTime.now();
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>OutboxRepository.java</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">OutboxRepository</span> <span style="color:#088;font-weight:bold">extends</span> JpaRepository&lt;OutboxMessageEntity, <span style="color:#0a8;font-weight:bold">Long</span>&gt; {
    <span style="color:#007">@Query</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">SELECT o FROM OutboxMessageEntity o WHERE o.status = 'PENDING'</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#0a8;font-weight:bold">List</span>&lt;OutboxMessageEntity&gt; findPendingMessages();
}</code></pre>
</div>
</div>
</li>
<li>
<p>OutboxService.java</p>
<div class="paragraph">
<p>Will do the following :
Save the transfer request in the Outbox table
and create schedule to check PENDING messages and Publish it to "payment-request" Kafka topic</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Slf4j</span>
<span style="color:#007">@Service</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OutboxService</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> CamelContext camelContext;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> OutboxRepository outboxRepository;

    <span style="color:#007">@Transactional</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> saveMessage(<span style="color:#0a8;font-weight:bold">UUID</span> paymentId, <span style="color:#0a8;font-weight:bold">String</span> aggregateType, <span style="color:#0a8;font-weight:bold">String</span> payload) {
        OutboxMessageEntity message = <span style="color:#080;font-weight:bold">new</span> OutboxMessageEntity();
        message.setPaymentId(paymentId);
        message.setAggregateType(aggregateType);
        message.setPayload(payload);
        message.setStatus(OutBoxStatus.PENDING.toString());
        outboxRepository.save(message);
    }

    <span style="color:#007">@Scheduled</span>(fixedRate = <span style="color:#00D">5000</span>)
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> processOutboxMessages() {
        <span style="color:#0a8;font-weight:bold">List</span>&lt;OutboxMessageEntity&gt; messages = outboxRepository.findPendingMessages();
        <span style="color:#080;font-weight:bold">for</span> (OutboxMessageEntity message : messages) {
            log.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">send to kafka topic name: {} paymentId: {}</span><span style="color:#710">&quot;</span></span>,message.getAggregateType(),message.getPaymentId());
            camelContext.createProducerTemplate()
                    <span style="color:#777">//.sendBodyAndHeader(&quot;kafka:&quot; + message.getAggregateType()+&quot;?key=&quot;+message.getPaymentId(),message.getPayload(), KafkaConstants.KEY,message.getPaymentId());</span>
                    .sendBody(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka:</span><span style="color:#710">&quot;</span></span> + message.getAggregateType()+<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">?key=</span><span style="color:#710">&quot;</span></span>+message.getPaymentId(), message.getPayload());
            message.setStatus(OutBoxStatus.PROCESSED.toString());
            outboxRepository.save(message);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you see above we use apache camel Context to send the transfer request to kafka :
camelContext.createProducerTemplate()
which use camel Uri to send data to the kafka topic.
to connect to Kafka in apache camel we add the following property:</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre>camel.component.kafka.brokers=PLAINTEXT_HOST://localhost:9092</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>At This stage we have received Transfer request in the Payment microservice , perform basic validation and Store the transfer details in OutBoxMessage table to be processed and published to "payment-request" Kafka Topic.</p>
</div>
<div class="paragraph">
<p>Now we will write our Camel router class to start Saga process:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TransferSagaRoute.java</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#007">@Component</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">TransferSagaRoute</span> <span style="color:#088;font-weight:bold">extends</span> RouteBuilder {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> TransferService transferService;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> InboxService inboxService;

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> configure() <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">Exception</span> {
        <span style="color:#777">//here we will configure our saga process flow</span>
        from(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka:</span><span style="color:#710">&quot;</span></span>+PAYMENT_REQUEST_TOPIC+<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">?groupId=payment-request-consumer-group</span><span style="color:#710">&quot;</span></span> +
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">&amp;autoOffsetReset=latest</span><span style="color:#710">&quot;</span></span>)
                .process(exchange -&gt; {
                    <span style="color:#0a8;font-weight:bold">String</span> paymentId = exchange.getIn().getHeader(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka.KEY</span><span style="color:#710">&quot;</span></span>, <span style="color:#0a8;font-weight:bold">String</span>.class);
                    <span style="color:#0a8;font-weight:bold">String</span> paymentDetails = exchange.getIn().getBody(<span style="color:#0a8;font-weight:bold">String</span>.class);
                    <span style="color:#080;font-weight:bold">if</span> (!inboxService.isProcessed(paymentId)) {
                        <span style="color:#777">// Store payment request in the database</span>
                        transferService.processTransferRequest(paymentDetails);
                        <span style="color:#777">// Save the state to the database</span>
                        inboxService.markAsProcessed(paymentId);
                        exchange.getIn().setBody(paymentDetails);
                        exchange.getIn().setHeader(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">paymentId</span><span style="color:#710">&quot;</span></span>, paymentId);
                    } <span style="color:#080;font-weight:bold">else</span> {
                        exchange.setProperty(Exchange.ROUTE_STOP, <span style="color:#069">true</span>);
                    }
                }).to(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka:fee-request?brokers=#{{camel.component.kafka.brokers}}</span><span style="color:#710">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>TransferEntity.java</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Data</span>
<span style="color:#007">@Entity</span>
<span style="color:#007">@Table</span>(name=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">t_transfer</span><span style="color:#710">&quot;</span></span>)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">TransferEntity</span> {

    <span style="color:#007">@Id</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">UUID</span> paymentId;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">UUID</span> requestId;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> senderAccountNumber;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> receiverAccountNumber;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">int</span> transferAmount;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> transferReason;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">int</span> feeAmount;

    <span style="color:#007">@Enumerated</span>(EnumType.STRING)
    <span style="color:#088;font-weight:bold">private</span> TransferState state;

    <span style="color:#007">@Column</span>(updatable = <span style="color:#069">false</span>, name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">created_date</span><span style="color:#710">&quot;</span></span> , columnDefinition = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">TIMESTAMP</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> LocalDateTime createdDate;

    <span style="color:#007">@Column</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">modified_date</span><span style="color:#710">&quot;</span></span> , columnDefinition = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">TIMESTAMP</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> LocalDateTime modifiedDate;

    <span style="color:#007">@PrePersist</span>
    <span style="color:#339;font-weight:bold">void</span> setCreatedDate(){
        <span style="color:#950">this</span>.createdDate = LocalDateTime.now();
    }

    <span style="color:#007">@PreUpdate</span>
    <span style="color:#339;font-weight:bold">void</span> setModifiedDate(){
        <span style="color:#950">this</span>.modifiedDate = LocalDateTime.now();
    }
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> fail() {
        <span style="color:#950">this</span>.state = TransferState.FAILED;
    }
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you can see, we launch the camel router that will consume the "payment-request" Kafka topic. We then check the inbox table to see if this payment message has already been processed in order to avoid duplication. Finally, we create the payment transfer details in the transfer table and forward the message to the Fee microservice, which calculates fees, via the Kafka topic "fee-request."</p>
</div>
<div class="paragraph">
<div class="title">Fee Microservice:</div>
<p>To begin calculating the transfer request fees in Fee Microservice, we will create a Kafka Listener on the "fee-request" topic. We will then publish the updated payment details together with the charge amount through the "fee-response" Kafka topic.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FeeService.java</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Slf4j</span>
<span style="color:#007">@Component</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">FeeService</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> InboxService inboxService;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> OutboxService outboxService;

    <span style="color:#007">@KafkaListener</span>(topics = FEE_REQUEST_TOPIC,
            containerFactory = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafkaListenerContainerFactory</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> consumer(<span style="color:#007">@Payload</span> <span style="color:#0a8;font-weight:bold">String</span>  paymentDetails, <span style="color:#007">@Headers</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">Object</span>&gt; headers , Acknowledgment acknowledgment) <span style="color:#088;font-weight:bold">throws</span> JsonProcessingException {
        <span style="color:#0a8;font-weight:bold">String</span> paymentId = (<span style="color:#0a8;font-weight:bold">String</span>) headers.get(KafkaHeaders.RECEIVED_KEY);
        <span style="color:#080;font-weight:bold">try</span> {
            <span style="color:#777">// Calculate fee logic</span>
            log.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">calculateFee  paymentId: {} ,paymentDetails: {}</span><span style="color:#710">&quot;</span></span>,paymentId,paymentDetails);
            ObjectMapper objectMapper = <span style="color:#080;font-weight:bold">new</span> ObjectMapper();
            TransferDto transferDto = objectMapper.readValue(paymentDetails, TransferDto.class);
            log.info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">TransferDto : {}</span><span style="color:#710">&quot;</span></span>,transferDto);
            <span style="color:#080;font-weight:bold">if</span> (!inboxService.isProcessed(paymentId)) {
                <span style="color:#777">// Calculate fee</span>
                <span style="color:#080;font-weight:bold">if</span>(transferDto.getTransferAmount()&gt;<span style="color:#00D">100</span>){
                    transferDto.setFee(<span style="color:#00D">5</span>);
                }<span style="color:#080;font-weight:bold">else</span>{
                    transferDto.setFee(<span style="color:#00D">1</span>);
                }
                transferDto.setState(TransferState.PROCESSING);

                <span style="color:#777">// Save outbox message</span>
                outboxService.saveMessage(transferDto.getPaymentId(),FEE_RESPONSE_TOPIC,objectMapper.writeValueAsString(transferDto));

                <span style="color:#777">// Save the state to the database</span>
                inboxService.markAsProcessed(paymentId);
                acknowledgment.acknowledge();
            }
        } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#C00;font-weight:bold">Exception</span> e) {
            <span style="color:#777">// Save compensation message to outbox table</span>
            outboxService.saveMessage(<span style="color:#0a8;font-weight:bold">UUID</span>.fromString(paymentId),COMPENSATION_FEE_REQUEST_TOPIC,paymentDetails);
            e.printStackTrace();
            <span style="color:#080;font-weight:bold">throw</span> e;
        }
    }
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>We had created kafka KafkaListener to read data from the topic and start processing the transfer request by calculating the fee and update the  transfer request details with the
required fee and publish to topic for our next step in saga "fee-response" ,
You can see that we start introducing compensation steps by publish transfer detail to  "compensation-fee-request" topic by this way any error occurred we will start the compensation steps in Saga in this scenario in the router class of the payment we will start handling  error and based on the step we do what is necessary reversal action and mark transfer request status as Failed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TransferSagaRoute.java in Payment microservice</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#007">@Component</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">TransferSagaRoute</span> <span style="color:#088;font-weight:bold">extends</span> RouteBuilder {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> TransferService transferService;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> InboxService inboxService;

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> configure() <span style="color:#088;font-weight:bold">throws</span> <span style="color:#C00;font-weight:bold">Exception</span> {
        <span style="color:#777">//here we will configure our saga process flow</span>
        from(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka:</span><span style="color:#710">&quot;</span></span>+PAYMENT_REQUEST_TOPIC+<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">?groupId=payment-request-consumer-group</span><span style="color:#710">&quot;</span></span> +
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">&amp;autoOffsetReset=latest</span><span style="color:#710">&quot;</span></span>)
                .process(exchange -&gt; {
                    <span style="color:#0a8;font-weight:bold">String</span> paymentId = exchange.getIn().getHeader(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka.KEY</span><span style="color:#710">&quot;</span></span>, <span style="color:#0a8;font-weight:bold">String</span>.class);
                    <span style="color:#0a8;font-weight:bold">String</span> paymentDetails = exchange.getIn().getBody(<span style="color:#0a8;font-weight:bold">String</span>.class);
                    <span style="color:#080;font-weight:bold">if</span> (!inboxService.isProcessed(paymentId,PAYMENT_REQUEST_TOPIC)) {
                        <span style="color:#777">// Store payment request in the database</span>
                        transferService.processTransferRequest(paymentDetails);

                        <span style="color:#777">// Save the state to the database</span>
                        inboxService.markAsProcessed(paymentId,PAYMENT_REQUEST_TOPIC,paymentDetails);
                        exchange.getIn().setBody(paymentDetails);
                        exchange.getIn().setHeader(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">paymentId</span><span style="color:#710">&quot;</span></span>, paymentId);
                    } <span style="color:#080;font-weight:bold">else</span> {
                        exchange.setProperty(Exchange.ROUTE_STOP, <span style="color:#069">true</span>);
                    }
                }).to(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka:</span><span style="color:#710">&quot;</span></span>+FEE_REQUEST_TOPIC+<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">?brokers=#{{camel.component.kafka.brokers}}</span><span style="color:#710">&quot;</span></span>);

        <span style="color:#777">//process fee response</span>
        from(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka:</span><span style="color:#710">&quot;</span></span>+FEE_RESPONSE_TOPIC+<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">?groupId=fee-response-consumer-group</span><span style="color:#710">&quot;</span></span> +
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">&amp;autoOffsetReset=latest</span><span style="color:#710">&quot;</span></span>).process(exchange-&gt;{
                    <span style="color:#777">//update payment details with fee amount</span>
                    <span style="color:#0a8;font-weight:bold">String</span> paymentId = exchange.getIn().getHeader(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka.KEY</span><span style="color:#710">&quot;</span></span>, <span style="color:#0a8;font-weight:bold">String</span>.class);
                    <span style="color:#0a8;font-weight:bold">String</span> paymentDetails = exchange.getIn().getBody(<span style="color:#0a8;font-weight:bold">String</span>.class);
                    <span style="color:#080;font-weight:bold">if</span> (!inboxService.isProcessed(paymentId,FEE_RESPONSE_TOPIC)) {
                        <span style="color:#777">//update transfer details</span>
                        transferService.updateFee(paymentDetails);

                        <span style="color:#777">// Save the state to the database</span>
                        inboxService.markAsProcessed(paymentId,FEE_RESPONSE_TOPIC,paymentDetails);
                        exchange.getIn().setBody(paymentDetails);
                        exchange.getIn().setHeader(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">paymentId</span><span style="color:#710">&quot;</span></span>, paymentId);
                    }
                }).to(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka:</span><span style="color:#710">&quot;</span></span>+ACCOUNT_REQUEST_TOPIC+<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">?brokers=#{{camel.component.kafka.brokers}}</span><span style="color:#710">&quot;</span></span>);<span style="color:#777">//Continue to Account step</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we will implement the Compensation steps in the router for the Fee calculation, as we need to consume "compensation-fee-request" topic and will mark the transfer request status as failed.</p>
</div>
</li>
<li>
<p>TransferSagaRoute.java</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">        <span style="color:#777">// Compensation routes</span>
        from(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka:</span><span style="color:#710">&quot;</span></span>+COMPENSATION_FEE_REQUEST_TOPIC+<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">?groupId=compensation-fee-request-group</span><span style="color:#710">&quot;</span></span> +
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">&amp;autoOffsetReset=latest</span><span style="color:#710">&quot;</span></span>)
                .process(exchange-&gt;{
                    <span style="color:#0a8;font-weight:bold">String</span> paymentId = exchange.getIn().getHeader(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">kafka.KEY</span><span style="color:#710">&quot;</span></span>, <span style="color:#0a8;font-weight:bold">String</span>.class);
                    <span style="color:#0a8;font-weight:bold">String</span> paymentDetails = exchange.getIn().getBody(<span style="color:#0a8;font-weight:bold">String</span>.class);
                    <span style="color:#080;font-weight:bold">if</span> (!inboxService.isProcessed(paymentId,COMPENSATION_FEE_REQUEST_TOPIC)) {
                        <span style="color:#777">//mark transfer as failed</span>
                        transferService.updateTransferStatus(<span style="color:#0a8;font-weight:bold">UUID</span>.fromString(paymentId), TransferState.FAILED);

                        <span style="color:#777">// Save the state to the database</span>
                        inboxService.markAsProcessed(paymentId,COMPENSATION_FEE_REQUEST_TOPIC,paymentDetails);
                    }
                });</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will keep do the same by sending to account-request kafka topic and in the account microservice we will create kafka Listener to consume messages and dot eh credit and debit ,also will handel the compensation step by mart the transfer request as failed.</p>
</div>
<div class="paragraph">
<p>Our kafka communication through Saga will be like :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/dt/saga-kafka.png" alt="Saga kafka Saga">
</div>
</div>
<div class="paragraph">
<p>You can access the complete code through <a href="https://github.com/motazco135/saga-bank-transfer">github</a></p>
</div>
<div class="paragraph">
<p><a href="https://motazco135.github.io/blog/">&#8592;Back</a></p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 3.0<br>
Last updated 2024-07-11 05:13:55 +0300
</div>
</div>
<script>
;(function () { /*! Asciidoctor Tabs | Copyright (c) 2018-present Dan Allen | MIT License */
  'use strict'

  var config = (document.currentScript || {}).dataset || {}
  var forEach = Array.prototype.forEach

  init(document.querySelectorAll('.tabs'))

  function init (tabsBlocks) {
    if (!tabsBlocks.length) return
    forEach.call(tabsBlocks, function (tabs) {
      var syncIds = tabs.classList.contains('is-sync') ? {} : undefined
      var tablist = tabs.querySelector('.tablist ul')
      tablist.setAttribute('role', 'tablist')
      var start
      forEach.call(tablist.querySelectorAll('li'), function (tab, idx) {
        tab.tabIndex = -1
        tab.setAttribute('role', tab.classList.add('tab') || 'tab')
        var id, anchor, syncId
        if (!(id = tab.id) && (anchor = tab.querySelector('a[id]'))) {
          id = tab.id = anchor.parentNode.removeChild(anchor).id
        }
        var panel = id && tabs.querySelector('.tabpanel[aria-labelledby~="' + id + '"]')
        if (!panel) return idx ? undefined : toggleSelected(tab, true) // invalid state
        syncIds && (((syncId = tab.textContent.trim()) in syncIds) ? (syncId = undefined) : true) &&
        (syncIds[(tab.dataset.syncId = syncId)] = tab)
        idx || (syncIds && (start = { tab: tab, panel: panel })) ? toggleHidden(panel, true) : toggleSelected(tab, true)
        tab.setAttribute('aria-controls', panel.id)
        panel.setAttribute('role', 'tabpanel')
        var onClick = syncId === undefined ? activateTab : activateTabSync
        tab.addEventListener('click', onClick.bind({ tabs: tabs, tab: tab, panel: panel }))
      })
      if (!tabs.closest('.tabpanel')) {
        forEach.call(tabs.querySelectorAll('.tabpanel table.tableblock'), function (table) {
          var container = Object.assign(document.createElement('div'), { className: 'tablecontainer' })
          table.parentNode.insertBefore(container, table).appendChild(table)
        })
      }
      if (start) {
        var syncGroupId
        for (var i = 0, lst = tabs.classList, len = lst.length, className; i !== len; i++) {
          if (!(className = lst.item(i)).startsWith('data-sync-group-id=')) continue
          tabs.dataset.syncGroupId = syncGroupId = lst.remove(className) || className.slice(19).replace(/\u00a0/g, ' ')
          break
        }
        if (syncGroupId === undefined) tabs.dataset.syncGroupId = syncGroupId = Object.keys(syncIds).sort().join('|')
        var preferredSyncId = 'syncStorageKey' in config &&
          window[(config.syncStorageScope || 'local') + 'Storage'].getItem(config.syncStorageKey + '-' + syncGroupId)
        var tab = preferredSyncId && syncIds[preferredSyncId]
        tab && Object.assign(start, { tab: tab, panel: document.getElementById(tab.getAttribute('aria-controls')) })
        toggleSelected(start.tab, true) || toggleHidden(start.panel, false)
      }
    })
    onHashChange()
    toggleClassOnEach(tabsBlocks, 'is-loading', 'remove')
    window.setTimeout(toggleClassOnEach.bind(null, tabsBlocks, 'is-loaded', 'add'), 0)
    window.addEventListener('hashchange', onHashChange)
  }

  function activateTab (e) {
    var tab = this.tab
    var tabs = this.tabs || (this.tabs = tab.closest('.tabs'))
    var panel = this.panel || (this.panel = document.getElementById(tab.getAttribute('aria-controls')))
    querySelectorWithSiblings(tabs, '.tablist .tab', 'tab').forEach(function (el) {
      toggleSelected(el, el === tab)
    })
    querySelectorWithSiblings(tabs, '.tabpanel', 'tabpanel').forEach(function (el) {
      toggleHidden(el, el !== panel)
    })
    if (!this.isSync && 'syncStorageKey' in config && 'syncGroupId' in tabs.dataset) {
      var storageKey = config.syncStorageKey + '-' + tabs.dataset.syncGroupId
      window[(config.syncStorageScope || 'local') + 'Storage'].setItem(storageKey, tab.dataset.syncId)
    }
    if (!e) return
    var loc = window.location
    var hashIdx = loc.hash ? loc.href.indexOf('#') : -1
    if (~hashIdx) window.history.replaceState(null, '', loc.href.slice(0, hashIdx))
    e.preventDefault()
  }

  function activateTabSync (e) {
    activateTab.call(this, e)
    var thisTabs = this.tabs
    var thisTab = this.tab
    var initialY = thisTabs.getBoundingClientRect().y
    forEach.call(document.querySelectorAll('.tabs'), function (tabs) {
      if (tabs === thisTabs || tabs.dataset.syncGroupId !== thisTabs.dataset.syncGroupId) return
      querySelectorWithSiblings(tabs, '.tablist .tab', 'tab').forEach(function (tab) {
        if (tab.dataset.syncId === thisTab.dataset.syncId) activateTab.call({ tabs: tabs, tab: tab, isSync: true })
      })
    })
    var shiftedBy = thisTabs.getBoundingClientRect().y - initialY
    if (shiftedBy && (shiftedBy = Math.round(shiftedBy))) window.scrollBy({ top: shiftedBy, behavior: 'instant' })
  }

  function querySelectorWithSiblings (scope, selector, siblingClass) {
    var el = scope.querySelector(selector)
    if (!el) return []
    var result = [el]
    while ((el = el.nextElementSibling) && el.classList.contains(siblingClass)) result.push(el)
    return result
  }

  function toggleClassOnEach (elements, className, method) {
    forEach.call(elements, function (el) {
      el.classList[method](className)
    })
  }

  function toggleHidden (el, state) {
    el.classList[(el.hidden = state) ? 'add' : 'remove']('is-hidden')
  }

  function toggleSelected (el, state) {
    el.setAttribute('aria-selected', '' + state)
    el.classList[state ? 'add' : 'remove']('is-selected')
    el.tabIndex = state ? 0 : -1
  }

  function onHashChange () {
    var id = window.location.hash.slice(1)
    if (!id) return
    var tab = document.getElementById(~id.indexOf('%') ? decodeURIComponent(id) : id)
    if (!(tab && tab.classList.contains('tab'))) return
    'syncId' in tab.dataset ? activateTabSync.call({ tab: tab }) : activateTab.call({ tab: tab })
  }
})()
</script>
</body>
</html>